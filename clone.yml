---

- name: Clone Galaxy
  block:

    - name: Update Galaxy to specified ref
      git:
        dest: "{{ galaxy_server_dir }}"
        force: "{{ galaxy_force_checkout }}"
        depth: "{{ galaxy_clone_depth | default(omit) }}"
        repo: "{{ galaxy_repo }}"
        version: "{{ galaxy_commit_id }}"
        executable: "{{ git_executable | default(omit) }}"
      #diff: "{{ galaxy_diff_mode_verbose }}"
      register: __galaxy_git_update_result
      notify:
        - "{{ galaxy_restart_handler_name }}"
        - email administrator with commit id

    - name: Report Galaxy version change
      debug:
        msg: "Galaxy version changed from '{{ __galaxy_git_update_result.before }}' to '{{ __galaxy_git_update_result.after }}'"
      changed_when: __galaxy_git_update_result is changed
      when: __galaxy_git_update_result is changed

    - name: Fix permissions on repo
      file:
        path:  "{{ galaxy_server_dir }}"
        owner: "{{ galaxy_user }}"
        group: "{{ galaxy_user }}"
        recurse: yes
      when: __galaxy_git_update_result is changed

  #remote_user: "{{ galaxy_user }}"
  #become_user: "{{ galaxy_user }}"
