- hosts: toolshedservers
  become: true
  become_user: root
  vars:
    galaxy_manage_systemd: yes
    galaxy_repo: https://github.com/galaxyproject/galaxy.git
    galaxy_commit_id: release_22.01
    galaxy_user: toolshed
    __galaxy_user_name: "{{ galaxy_user }}"
    __galaxy_user_group: "{{ galaxy_user }}"
    __galaxy_systemd_memory_limit:
      # This is for the entire group of uWSGI master, web worker, and mule processes
      mule: 16
      reports: 5
    __galaxy_systemd_memory_limit_merged: "{{ __galaxy_systemd_memory_limit | combine(galaxy_systemd_memory_limit | default({})) }}"
    galaxy_systemd_env: []
    galaxy_server_dir: /evol/srv/toolshed/server
    galaxy_root: /evol/srv/toolshed

  pre_tasks:
    - name: Install Dependencies
      apt:
         name: ['acl', 'bzip2', 'git', 'make', 'python3-pip', 'python3-virtualenv', 'tar', 'virtualenv', 'mercurial', 'supervisor', 'libglib2.0-dev', 'zutils', 'unzip', 'rsync']
    - name: Add toolshed user
      ansible.builtin.user:
        name: toolshed
    - include: clone.yml

  roles:
    - role: galaxyproject.galaxy_toolshed
      become_user: "toolshed"
      galaxy_toolshed_manage_static_setup: yes
      galaxy_toolshed_manage_database: yes
      galaxy_manage_systemd: true
      galaxy_build_client: true
    - galaxyproject.nginx

  post_tasks:
    - name: Ansible copy file to remote server
      copy:
          src: "{{ galaxy_server_dir }}/static/"
          dest: "/var/www/tsstatic/"
          group: www-data
          owner: www-data
          remote_src: true
    - name: Create Tool Shed hgweb dir
      file:
        state: directory
        path: "{{ galaxy_toolshed_mutable_config_dir }}/hgweb_config_dir"
        group: toolshed
        owner: toolshed
    - name: Create Tool Shed hgweb file
      copy:
        content: "[paths]"
        dest: "{{ galaxy_toolshed_mutable_config_dir }}/hgweb_config_dir/hgweb.config"
        force: no
        group: toolshed
        owner: toolshed
    - name: Fixup system service
      block:
        - name: Deploy Toolshed Unit

          template:
            owner: root
            group: root
            mode: 0644
            src: systemd/toolshed.service.j2
            dest: /etc/systemd/system/toolshed.service
          notify:
            - daemon reload

        - name: Enable Toolshed Unit
          systemd:
            name: toolshed.service
            enabled: yes


  handlers:
    - name: Restart Toolshed
      become: yes
      systemd:
        name: toolshed
        state: restarted


  #handlers:
    #- name: Restart Galaxy
      #supervisorctl:
        #name: galaxy
        #state: restarted
